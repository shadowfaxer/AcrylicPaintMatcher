<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acrylic Color Mixer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* Prevents pull-to-refresh on mobile */
        }
        .font-inter { /* Ensure Inter is loaded if Tailwind doesn't pick it up by default */
            font-family: 'Inter', sans-serif;
        }
        #imageCanvas {
            cursor: crosshair;
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #e5e7eb; /* border-gray-200 */
        }
        #cameraStream {
            width: 100%;
            max-height: 400px; /* Limit height of camera preview */
            height: auto;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db; /* border-gray-300 */
            background-color: #000; /* Black background for video element */
        }
        .color-swatch {
            width: 50px;
            height: 50px;
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #9ca3af; /* border-gray-400 */
            display: inline-block;
            vertical-align: middle;
        }
        .paint-swatch {
            width: 20px;
            height: 20px;
            border-radius: 0.25rem; /* rounded-sm */
            border: 1px solid #9ca3af; /* border-gray-400 */
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        /* Custom modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 500px;
            border-radius: 0.5rem;
            text-align: center;
        }
        .modal-close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .modal-close-button:hover,
        .modal-close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .loader {
            border: 5px solid #f3f3f3; /* Light grey */
            border-top: 5px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4 font-inter">

    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-2xl">
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-800">Acrylic Color Mixer</h1>
            <p class="text-sm text-gray-600 mt-2">Upload an image, pick a color, and get a Winsor & Newton acrylic paint mixing suggestion.</p>
        </header>

        <div id="imageInputSection">
            <div id="fileUploadSection" class="mb-4">
                <label for="imageUpload" class="block text-sm font-medium text-gray-700 mb-1">Upload Image:</label>
                <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer focus:outline-none focus:border-blue-500 p-2.5">
            </div>

            <div class="text-center my-3">
                <span class="text-gray-500 text-sm">OR</span>
            </div>

            <button id="useCameraButton" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 ease-in-out mb-4">
                Use Camera
            </button>
        </div>

        <div id="cameraView" class="hidden mb-4">
            <video id="cameraStream" playsinline autoplay muted class="mb-2"></video> <button id="takePhotoButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                Take Photo
            </button>
            <button id="cancelCameraButton" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 transition duration-150 ease-in-out mt-2">
                Cancel Camera
            </button>
        </div>


        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <h2 class="text-lg font-semibold text-gray-700 mb-2">Image Preview:</h2>
                <canvas id="imageCanvas" class="bg-gray-200"></canvas>
                <p id="canvasHelperText" class="text-xs text-gray-500 mt-1 text-center">Upload an image or use camera to begin.</p>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-gray-700 mb-2">Selected Color:</h2>
                <div id="selectedColorInfo" class="p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[100px] flex items-center justify-center">
                    <span class="text-gray-500">No color selected</span>
                </div>

                <button id="findMixButton" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    Find Paint Mix
                </button>
            </div>
        </div>

        <div class="mb-4">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Suggested Paint Mix:</h2>
            <div id="mixingResult" class="p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[120px]">
                <p class="text-gray-500">Upload an image and select a color to see suggestions.</p>
            </div>
        </div>

        <div class="mt-6 p-3 bg-yellow-50 border border-yellow-300 rounded-lg text-yellow-700 text-xs">
            <p><strong>Disclaimer:</strong> Paint data and mixing simulations are approximations. Actual paint mixing results may vary. Use these suggestions as a starting point for your own experimentation. The list of paints used here is a limited sample and not exhaustive of the full Winsor & Newton range.</p>
        </div>
    </div>

    <div id="loadingModal" class="modal">
        <div class="modal-content">
            <p class="text-lg font-semibold mb-2">Calculating Mix...</p>
            <div class="loader"></div>
            <p class="text-sm text-gray-600">This might take a moment for complex images or colors.</p>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const imageUpload = document.getElementById('imageUpload');
        const imageCanvas = document.getElementById('imageCanvas');
        const canvasCtx = imageCanvas.getContext('2d');
        const selectedColorInfo = document.getElementById('selectedColorInfo');
        const findMixButton = document.getElementById('findMixButton');
        const mixingResult = document.getElementById('mixingResult');
        const canvasHelperText = document.getElementById('canvasHelperText');
        const loadingModal = document.getElementById('loadingModal');

        // Camera specific DOM elements
        const imageInputSection = document.getElementById('imageInputSection');
        const useCameraButton = document.getElementById('useCameraButton');
        const cameraView = document.getElementById('cameraView');
        const cameraStreamElement = document.getElementById('cameraStream');
        const takePhotoButton = document.getElementById('takePhotoButton');
        const cancelCameraButton = document.getElementById('cancelCameraButton');
        let stream = null; // To store the camera stream

        let currentImage = null;
        let selectedRgb = null;

        // --- Paint Database (Simulated Winsor & Newton Acrylics - Galeria or Professional range examples) ---
        // IMPORTANT: These RGB values are illustrative approximations and not official or precisely measured data.
        const WINSOR_NEWTON_ACRYLICS = [
            { name: "Pro Titanium White", rgb: { r: 223, g: 221, b: 217 } }, //rgb(223, 221, 217)
            { name: "Pro Cadmium Yellow Light", rgb: { r: 222, g: 194, b: 3 } }, //rgb(222, 194, 3)
            { name: "Galeria Cadmium Yellow Medium Hue", rgb: { r: 249, g: 197, b: 0 } }, //rgb(249, 197, 0)
            { name: "Galeria Yellow Ochre", rgb: { r: 166, g: 115, b: 19 } }, //rgb(166, 115, 19)
            { name: "Pro Raw Sienna", rgb: { r: 122, g: 81, b: 46 } }, //rgb(122, 81, 46)
            { name: "Galeria Raw Sienna", rgb: { r: 114, g: 61, b: 23 } }, //rgb(114, 61, 23)
            { name: "Pro Cadmium Red Light", rgb: { r: 217, g: 53, b: 28 } }, //rgb(217, 53, 28)
            { name: "Galeria Permanent Alizarin Crimson", rgb: { r: 137, g: 11, b: 24 } }, //rgb(137, 11, 24)
            { name: "Pro Cerulean Blue", rgb: { r: 1, g: 100, b: 184 } }, //rgb(1, 100, 184)
            { name: "Pro Phthalo Blue (Green Shade)", rgb: { r: 21, g: 26, b: 52 } },
            { name: "Galeria Permanent Alizarin Crimson", rgb: { r: 143, g: 11, b: 25 } },
            { name: "Pro Phthalo Blue (Red Shade)", rgb: { r: 27, g: 28, b: 49 } },
            { name: "Pro Ultramarine Blue", rgb: { r: 2, g: 38, b: 150 } },
            { name: "Galeria Payne's Gray", rgb: { r: 32, g: 34, b: 38 } },
            { name: "Pro Mixing White", rgb: { r: 225, g: 223, b: 218 } },
        ];

        // --- Event Listeners ---
        imageUpload.addEventListener('change', handleImageUpload);
        imageCanvas.addEventListener('click', handleCanvasClick);
        findMixButton.addEventListener('click', handleFindMix);
        useCameraButton.addEventListener('click', startCamera);
        takePhotoButton.addEventListener('click', takePhoto);
        cancelCameraButton.addEventListener('click', cancelCamera);


        // --- Image Loading and Processing ---
        function loadImageOnCanvas(imageSrc) {
            currentImage = new Image();
            currentImage.onload = () => {
                const parentWidth = imageCanvas.parentElement.clientWidth;
                const maxWidth = (parentWidth && parentWidth > 0) ? Math.min(parentWidth, 500) : 500;
                
                const scale = Math.min(maxWidth / currentImage.width, 1);
                imageCanvas.width = currentImage.width * scale;
                imageCanvas.height = currentImage.height * scale;
                canvasCtx.drawImage(currentImage, 0, 0, imageCanvas.width, imageCanvas.height);
                
                selectedColorInfo.innerHTML = '<span class="text-gray-500">Click image to pick color</span>';
                selectedRgb = null;
                findMixButton.disabled = true;
                mixingResult.innerHTML = '<p class="text-gray-500">Pick a color to see suggestions.</p>';
                canvasHelperText.textContent = 'Click on the image to select a color.';
                
                // Ensure camera view is hidden and input section is visible
                cameraView.classList.add('hidden');
                imageInputSection.classList.remove('hidden');
                stopCameraStream(); // Stop stream if it was active
            };
            currentImage.onerror = () => {
                canvasHelperText.textContent = 'Error loading image.';
                alertUser('Error: Could not load the image. Please try again.');
                cameraView.classList.add('hidden');
                imageInputSection.classList.remove('hidden');
                stopCameraStream();
            };
            currentImage.src = imageSrc;
        }

        // --- Image File Handling ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    loadImageOnCanvas(e.target.result);
                }
                reader.readAsDataURL(file);
            }
        }

        // --- Camera Handling ---
        async function startCamera() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); // Prefer rear camera
                    cameraStreamElement.srcObject = stream;
                    imageInputSection.classList.add('hidden');
                    cameraView.classList.remove('hidden');
                    canvasHelperText.textContent = 'Position camera and take photo.';
                } catch (err) {
                    console.error("Error accessing camera: ", err);
                    // Fallback to user-facing camera if environment fails or provide more specific error
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        cameraStreamElement.srcObject = stream;
                        imageInputSection.classList.add('hidden');
                        cameraView.classList.remove('hidden');
                        canvasHelperText.textContent = 'Position camera and take photo.';
                    } catch (fallbackErr) {
                         console.error("Error accessing any camera: ", fallbackErr);
                         alertUser("Could not access camera. Please ensure permissions are granted and try again. You can still upload a file.");
                         imageInputSection.classList.remove('hidden');
                         cameraView.classList.add('hidden');
                    }
                }
            } else {
                alertUser("Camera API not supported by your browser. Please upload a file.");
            }
        }

        function takePhoto() {
            if (!stream || !cameraStreamElement.videoWidth) { // Check if stream is active and video has dimensions
                alertUser("Camera not ready or stream not active.");
                return;
            }
            const tempCanvas = document.createElement('canvas');
            // Set canvas dimensions to the video's actual dimensions to capture full quality
            tempCanvas.width = cameraStreamElement.videoWidth;
            tempCanvas.height = cameraStreamElement.videoHeight;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.drawImage(cameraStreamElement, 0, 0, tempCanvas.width, tempCanvas.height);
            
            const dataUrl = tempCanvas.toDataURL('image/png');
            loadImageOnCanvas(dataUrl); // This will also stop the stream and hide camera view
        }

        function stopCameraStream() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                cameraStreamElement.srcObject = null; // Clear the video element
            }
        }

        function cancelCamera() {
            stopCameraStream();
            cameraView.classList.add('hidden');
            imageInputSection.classList.remove('hidden');
            if (!currentImage) { // If no image was previously loaded, reset helper text
                 drawInitialCanvasPlaceholder(); // Redraw placeholder if no image is active
                 canvasHelperText.textContent = 'Upload an image or use camera to begin.';
            } else {
                 canvasHelperText.textContent = 'Click on the image to select a color.';
            }
        }


        // --- Color Picking ---
        function handleCanvasClick(event) {
            if (!currentImage) {
                // Do not show alert if camera view is active, as user might be trying to interact with that
                if (cameraView.classList.contains('hidden')) {
                    alertUser("Please upload an image or take a photo first.");
                }
                return;
            }

            const rect = imageCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            if (x < 0 || x >= imageCanvas.width || y < 0 || y >= imageCanvas.height) {
                return;
            }

            const pixelData = canvasCtx.getImageData(x, y, 1, 1).data;
            selectedRgb = { r: pixelData[0], g: pixelData[1], b: pixelData[2] };

            selectedColorInfo.innerHTML = `
                <div class="flex items-center">
                    <span class="color-swatch mr-3" style="background-color: rgb(${selectedRgb.r}, ${selectedRgb.g}, ${selectedRgb.b});"></span>
                    <div>
                        <p class="font-semibold text-gray-800">RGB: (${selectedRgb.r}, ${selectedRgb.g}, ${selectedRgb.b})</p>
                        <p class="text-sm text-gray-600">Hex: #${rgbToHex(selectedRgb.r, selectedRgb.g, selectedRgb.b)}</p>
                    </div>
                </div>
            `;
            findMixButton.disabled = false;
            mixingResult.innerHTML = '<p class="text-gray-500">Click "Find Paint Mix" to get suggestions.</p>';
        }

        // --- Color Mixing Logic ---
        async function handleFindMix() {
            if (!selectedRgb) {
                alertUser("Please select a color from the image first.");
                return;
            }

            showLoadingModal(true);
            mixingResult.innerHTML = '<p class="text-gray-600">Calculating best mix...</p>';

            await new Promise(resolve => setTimeout(resolve, 50)); // Allow UI to update

            try {
                const bestMix = findClosestPaintMix(selectedRgb);
                displayMixResult(bestMix);
            } catch (error) {
                console.error("Error finding mix:", error);
                mixingResult.innerHTML = '<p class="text-red-500">Error calculating mix. Please try again.</p>';
                alertUser(`An error occurred: ${error.message}`);
            } finally {
                showLoadingModal(false);
            }
        }

        function colorDiff(rgb1, rgb2) {
            const dr = rgb1.r - rgb2.r;
            const dg = rgb1.g - rgb2.g;
            const db = rgb1.b - rgb2.b;
            return Math.sqrt(dr * dr + dg * dg + db * db);
        }

        function mixTwoColors(color1, ratio1, color2, ratio2) {
            const totalRatio = ratio1 + ratio2;
            if (totalRatio === 0) return { r: 0, g: 0, b: 0 };
            return {
                r: Math.round((color1.rgb.r * ratio1 + color2.rgb.r * ratio2) / totalRatio),
                g: Math.round((color1.rgb.g * ratio1 + color2.rgb.g * ratio2) / totalRatio),
                b: Math.round((color1.rgb.b * ratio1 + color2.rgb.b * ratio2) / totalRatio)
            };
        }

        function mixThreeColors(color1, ratio1, color2, ratio2, color3, ratio3) {
            const totalRatio = ratio1 + ratio2 + ratio3;
            if (totalRatio === 0) return { r: 0, g: 0, b: 0 };
            return {
                r: Math.round((color1.rgb.r * ratio1 + color2.rgb.r * ratio2 + color3.rgb.r * ratio3) / totalRatio),
                g: Math.round((color1.rgb.g * ratio1 + color2.rgb.g * ratio2 + color3.rgb.g * ratio3) / totalRatio),
                b: Math.round((color1.rgb.b * ratio1 + color2.rgb.b * ratio2 + color3.rgb.b * ratio3) / totalRatio)
            };
        }

        function findClosestPaintMix(targetRgb) {
            let bestMatch = { paintNames: [], mixedRgb: null, diff: Infinity, recipe: "" };

            // 1. Check single paints
            for (const paint of WINSOR_NEWTON_ACRYLICS) {
                const diff = colorDiff(targetRgb, paint.rgb);
                if (diff < bestMatch.diff) {
                    bestMatch = { paintNames: [paint.name], mixedRgb: paint.rgb, diff: diff, recipe: `1 part ${paint.name}` };
                }
            }

            // 2. Check two-paint mixes
            const ratios = [ { r1: 1, r2: 3 }, { r1: 1, r2: 2 }, { r1: 1, r2: 1 }, { r1: 2, r2: 1 }, { r1: 3, r2: 1 } ];
            for (let i = 0; i < WINSOR_NEWTON_ACRYLICS.length; i++) {
                for (let j = i + 1; j < WINSOR_NEWTON_ACRYLICS.length; j++) {
                    const p1 = WINSOR_NEWTON_ACRYLICS[i];
                    const p2 = WINSOR_NEWTON_ACRYLICS[j];
                    for (const ratio of ratios) {
                        let mixed = mixTwoColors(p1, ratio.r1, p2, ratio.r2);
                        let d = colorDiff(targetRgb, mixed);
                        if (d < bestMatch.diff) {
                            bestMatch = { paintNames: [p1.name, p2.name], mixedRgb: mixed, diff: d, recipe: `${ratio.r1} part(s) ${p1.name} + ${ratio.r2} part(s) ${p2.name}` };
                        }
                        if (ratio.r1 !== ratio.r2) { // Try swapped if ratios are different
                            mixed = mixTwoColors(p1, ratio.r2, p2, ratio.r1);
                            d = colorDiff(targetRgb, mixed);
                            if (d < bestMatch.diff) {
                                bestMatch = { paintNames: [p1.name, p2.name], mixedRgb: mixed, diff: d, recipe: `${ratio.r2} part(s) ${p1.name} + ${ratio.r1} part(s) ${p2.name}` };
                            }
                        }
                    }
                }
            }
            
            // 3. Check three-paint mixes
            if (WINSOR_NEWTON_ACRYLICS.length >= 3) {
                for (let i = 0; i < WINSOR_NEWTON_ACRYLICS.length; i++) {
                    for (let j = i + 1; j < WINSOR_NEWTON_ACRYLICS.length; j++) {
                        for (let k = j + 1; k < WINSOR_NEWTON_ACRYLICS.length; k++) {
                            const p1 = WINSOR_NEWTON_ACRYLICS[i];
                            const p2 = WINSOR_NEWTON_ACRYLICS[j];
                            const p3 = WINSOR_NEWTON_ACRYLICS[k];
                            
                            // Equal parts
                            let mixed = mixThreeColors(p1, 1, p2, 1, p3, 1);
                            let d = colorDiff(targetRgb, mixed);
                            if (d < bestMatch.diff) {
                                bestMatch = { paintNames: [p1.name, p2.name, p3.name], mixedRgb: mixed, diff: d, recipe: `1 part ${p1.name} + 1 part ${p2.name} + 1 part ${p3.name} (approx. equal parts)` };
                            }

                            // Dominant mixes
                            const dominantRatios = [ {r1:2, r2:1, r3:1}, {r1:1, r2:2, r3:1}, {r1:1, r2:1, r3:2} ];
                            for (const dr of dominantRatios) {
                                mixed = mixThreeColors(p1, dr.r1, p2, dr.r2, p3, dr.r3);
                                d = colorDiff(targetRgb, mixed);
                                if (d < bestMatch.diff) {
                                     bestMatch = { paintNames: [p1.name, p2.name, p3.name], mixedRgb: mixed, diff: d, recipe: `${dr.r1} part(s) ${p1.name} + ${dr.r2} part(s) ${p2.name} + ${dr.r3} part(s) ${p3.name}` };
                                }
                            }
                        }
                    }
                }
            }
            return bestMatch;
        }

        function displayMixResult(mix) {
            if (!mix || !mix.mixedRgb) {
                mixingResult.innerHTML = '<p class="text-red-500">Could not find a suitable mix.</p>';
                return;
            }
            let paintSwatchesHTML = '';
            if (mix.paintNames && mix.paintNames.length > 0) {
                mix.paintNames.forEach(name => {
                    const paintData = WINSOR_NEWTON_ACRYLICS.find(p => p.name === name);
                    if (paintData) {
                        paintSwatchesHTML += `<span class="paint-swatch" style="background-color: rgb(${paintData.rgb.r}, ${paintData.rgb.g}, ${paintData.rgb.b});" title="${name}"></span>`;
                    }
                });
            }
            mixingResult.innerHTML = `
                <div class="flex items-center mb-3">
                    <span class="color-swatch mr-3" style="background-color: rgb(${mix.mixedRgb.r}, ${mix.mixedRgb.g}, ${mix.mixedRgb.b});"></span>
                    <div>
                        <p class="font-semibold text-gray-800">Closest Mix Found (RGB: ${mix.mixedRgb.r}, ${mix.mixedRgb.g}, ${mix.mixedRgb.b})</p>
                        <p class="text-sm text-gray-600">Color Difference Score: ${mix.diff.toFixed(2)} (lower is better)</p>
                    </div>
                </div>
                <p class="text-gray-700 font-medium mb-1">Recipe:</p>
                <div class="flex items-center mb-2"> ${paintSwatchesHTML} </div>
                <p class="text-gray-700 bg-gray-100 p-2 rounded">${mix.recipe}</p>
            `;
        }

        // --- Utility Functions ---
        function componentToHex(c) {
            const hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }
        function rgbToHex(r, g, b) {
            return componentToHex(r) + componentToHex(g) + componentToHex(b);
        }
        function showLoadingModal(show) {
            loadingModal.style.display = show ? "block" : "none";
        }
        function alertUser(message) {
            let existingModal = document.getElementById('alertModal');
            if (existingModal) existingModal.remove();
            const alertModal = document.createElement('div');
            alertModal.id = 'alertModal';
            alertModal.className = 'modal';
            alertModal.style.display = 'block';
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            const closeButton = document.createElement('span');
            closeButton.className = 'modal-close-button';
            closeButton.innerHTML = '&times;';
            closeButton.onclick = () => { alertModal.style.display = 'none'; alertModal.remove(); };
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.className = 'text-gray-700 my-4';
            const okButton = document.createElement('button');
            okButton.textContent = 'OK';
            okButton.className = 'bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg';
            okButton.onclick = () => { alertModal.style.display = 'none'; alertModal.remove(); };
            modalContent.appendChild(closeButton);
            modalContent.appendChild(messageP);
            modalContent.appendChild(okButton);
            alertModal.appendChild(modalContent);
            document.body.appendChild(alertModal);
        }

        // Initial canvas placeholder
        function drawInitialCanvasPlaceholder() {
            const parentWidth = imageCanvas.parentElement.clientWidth;
            imageCanvas.width = (parentWidth && parentWidth > 0) ? Math.min(parentWidth, 500) : 300;
            imageCanvas.height = imageCanvas.width * (2/3);
            canvasCtx.fillStyle = '#e5e7eb';
            canvasCtx.fillRect(0, 0, imageCanvas.width, imageCanvas.height);
            canvasCtx.fillStyle = '#9ca3af';
            canvasCtx.textAlign = 'center';
            canvasCtx.textBaseline = 'middle';
            canvasCtx.font = '14px Inter';
            wrapText(canvasCtx, 'Upload an image or use camera to begin', imageCanvas.width / 2, imageCanvas.height / 2, imageCanvas.width - 20, 18);
            canvasHelperText.textContent = 'Upload an image or use camera to begin.';
        }
        function wrapText(context, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            for(let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = context.measureText(testLine);
                const testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    context.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                } else { line = testLine; }
            }
            context.fillText(line, x, y);
        }

        // Call on load
        drawInitialCanvasPlaceholder();
        // Adjust canvas on resize
        window.addEventListener('resize', () => {
            if (!currentImage && cameraView.classList.contains('hidden')) {
                 drawInitialCanvasPlaceholder();
            } else if (currentImage) {
                // Redraw current image to fit new size
                const parentWidth = imageCanvas.parentElement.clientWidth;
                const maxWidth = (parentWidth && parentWidth > 0) ? Math.min(parentWidth, 500) : 500;
                const scale = Math.min(maxWidth / currentImage.width, 1);
                imageCanvas.width = currentImage.width * scale;
                imageCanvas.height = currentImage.height * scale;
                canvasCtx.drawImage(currentImage, 0, 0, imageCanvas.width, imageCanvas.height);
            }
            // If camera is active, the video element will handle its own responsiveness.
        });

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acrylic Color Mixer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none; /* Prevents pull-to-refresh on mobile */
        }
        .font-inter { /* Ensure Inter is loaded if Tailwind doesn't pick it up by default */
            font-family: 'Inter', sans-serif;
        }
        #imageCanvas {
            cursor: crosshair;
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #e5e7eb; /* border-gray-200 */
        }
        .color-swatch {
            width: 50px;
            height: 50px;
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #9ca3af; /* border-gray-400 */
            display: inline-block;
            vertical-align: middle;
        }
        .paint-swatch {
            width: 20px;
            height: 20px;
            border-radius: 0.25rem; /* rounded-sm */
            border: 1px solid #9ca3af; /* border-gray-400 */
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        /* Custom modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 500px;
            border-radius: 0.5rem;
            text-align: center;
        }
        .modal-close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .modal-close-button:hover,
        .modal-close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .loader {
            border: 5px solid #f3f3f3; /* Light grey */
            border-top: 5px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4 font-inter">

    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-2xl">
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-800">Acrylic Color Mixer</h1>
            <p class="text-sm text-gray-600 mt-2">Upload an image, pick a color, and get a Winsor & Newton acrylic paint mixing suggestion.</p>
        </header>

        <div class="mb-6">
            <label for="imageUpload" class="block text-sm font-medium text-gray-700 mb-1">Upload Image:</label>
            <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 cursor-pointer focus:outline-none focus:border-blue-500 p-2.5">
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <h2 class="text-lg font-semibold text-gray-700 mb-2">Image Preview:</h2>
                <canvas id="imageCanvas" class="bg-gray-200"></canvas>
                <p id="canvasHelperText" class="text-xs text-gray-500 mt-1 text-center">Click on the image to select a color.</p>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-gray-700 mb-2">Selected Color:</h2>
                <div id="selectedColorInfo" class="p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[100px] flex items-center justify-center">
                    <span class="text-gray-500">No color selected</span>
                </div>

                <button id="findMixButton" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    Find Paint Mix
                </button>
            </div>
        </div>

        <div class="mb-4">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Suggested Paint Mix:</h2>
            <div id="mixingResult" class="p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[120px]">
                <p class="text-gray-500">Upload an image and select a color to see suggestions.</p>
            </div>
        </div>

        <div class="mt-6 p-3 bg-yellow-50 border border-yellow-300 rounded-lg text-yellow-700 text-xs">
            <p><strong>Disclaimer:</strong> Paint data and mixing simulations are approximations. Actual paint mixing results may vary. Use these suggestions as a starting point for your own experimentation. The list of paints used here is a limited sample and not exhaustive of the full Winsor & Newton range.</p>
        </div>
    </div>

    <div id="loadingModal" class="modal">
        <div class="modal-content">
            <p class="text-lg font-semibold mb-2">Calculating Mix...</p>
            <div class="loader"></div>
            <p class="text-sm text-gray-600">This might take a moment for complex images or colors.</p>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const imageUpload = document.getElementById('imageUpload');
        const imageCanvas = document.getElementById('imageCanvas');
        const canvasCtx = imageCanvas.getContext('2d');
        const selectedColorInfo = document.getElementById('selectedColorInfo');
        const findMixButton = document.getElementById('findMixButton');
        const mixingResult = document.getElementById('mixingResult');
        const canvasHelperText = document.getElementById('canvasHelperText');
        const loadingModal = document.getElementById('loadingModal');

        let currentImage = null;
        let selectedRgb = null;

        // --- Paint Database (Simulated Winsor & Newton Acrylics - Galeria or Professional range examples) ---
        // IMPORTANT: These RGB values are illustrative approximations and not official or precisely measured data.
        const WINSOR_NEWTON_ACRYLICS = [
            { name: "Titanium White", rgb: { r: 248, g: 249, b: 250 } }, // Brighter white
            { name: "Ivory Black", rgb: { r: 35, g: 35, b: 35 } }, // Darker black
            { name: "Cadmium Yellow Medium Hue", rgb: { r: 255, g: 215, b: 0 } }, // Gold-ish yellow
            { name: "Lemon Yellow Hue", rgb: { r: 255, g: 245, b: 100 } },
            { name: "Cadmium Red Hue", rgb: { r: 220, g: 20, b: 60 } }, // Crimson-like
            { name: "Permanent Rose", rgb: { r: 227, g: 69, b: 139 } },
            { name: "Ultramarine", rgb: { r: 25, g: 40, b: 140 } }, // Deeper blue
            { name: "Cerulean Blue Hue", rgb: { r: 60, g: 150, b: 220 } },
            { name: "Phthalo Green (Blue Shade)", rgb: { r: 0, g: 105, b: 90 } },
            { name: "Permanent Green Light", rgb: { r: 80, g: 180, b: 70 } },
            { name: "Yellow Ochre", rgb: { r: 204, g: 153, b: 51 } },
            { name: "Burnt Sienna", rgb: { r: 138, g: 54, b: 15 } },
            { name: "Raw Umber", rgb: { r: 90, g: 70, b: 50 } },
            { name: "Dioxazine Purple", rgb: { r: 80, g: 40, b: 120 } },
            { name: "Pale Olive", rgb: { r: 150, g: 155, b: 100 } } // Example of a mixed-looking color
        ];

        // --- Event Listeners ---
        imageUpload.addEventListener('change', handleImageUpload);
        imageCanvas.addEventListener('click', handleCanvasClick);
        findMixButton.addEventListener('click', handleFindMix);

        // --- Image Handling ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentImage = new Image();
                    currentImage.onload = () => {
                        // Resize canvas to fit image while maintaining aspect ratio, max width 500px
                        const maxWidth = imageCanvas.parentElement.clientWidth > 0 ? Math.min(imageCanvas.parentElement.clientWidth, 500) : 500;
                        const scale = Math.min(maxWidth / currentImage.width, 1); // Don't scale up
                        imageCanvas.width = currentImage.width * scale;
                        imageCanvas.height = currentImage.height * scale;
                        canvasCtx.drawImage(currentImage, 0, 0, imageCanvas.width, imageCanvas.height);
                        selectedColorInfo.innerHTML = '<span class="text-gray-500">Click image to pick color</span>';
                        selectedRgb = null;
                        findMixButton.disabled = true;
                        mixingResult.innerHTML = '<p class="text-gray-500">Pick a color to see suggestions.</p>';
                        canvasHelperText.textContent = 'Click on the image to select a color.';
                    }
                    currentImage.onerror = () => {
                        canvasHelperText.textContent = 'Error loading image.';
                        alertUser('Error: Could not load the image file. Please try a different image.');
                    }
                    currentImage.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        // --- Color Picking ---
        function handleCanvasClick(event) {
            if (!currentImage) {
                alertUser("Please upload an image first.");
                return;
            }

            const rect = imageCanvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            // Ensure click is within canvas bounds
            if (x < 0 || x >= imageCanvas.width || y < 0 || y >= imageCanvas.height) {
                return;
            }

            const pixelData = canvasCtx.getImageData(x, y, 1, 1).data;
            selectedRgb = { r: pixelData[0], g: pixelData[1], b: pixelData[2] };

            selectedColorInfo.innerHTML = `
                <div class="flex items-center">
                    <span class="color-swatch mr-3" style="background-color: rgb(${selectedRgb.r}, ${selectedRgb.g}, ${selectedRgb.b});"></span>
                    <div>
                        <p class="font-semibold text-gray-800">RGB: (${selectedRgb.r}, ${selectedRgb.g}, ${selectedRgb.b})</p>
                        <p class="text-sm text-gray-600">Hex: #${rgbToHex(selectedRgb.r, selectedRgb.g, selectedRgb.b)}</p>
                    </div>
                </div>
            `;
            findMixButton.disabled = false;
            mixingResult.innerHTML = '<p class="text-gray-500">Click "Find Paint Mix" to get suggestions.</p>';
        }

        // --- Color Mixing Logic ---
        async function handleFindMix() {
            if (!selectedRgb) {
                alertUser("Please select a color from the image first.");
                return;
            }

            showLoadingModal(true);
            mixingResult.innerHTML = '<p class="text-gray-600">Calculating best mix...</p>';

            // Use a timeout to allow the UI to update before the potentially blocking calculation
            await new Promise(resolve => setTimeout(resolve, 50));

            try {
                const bestMix = findClosestPaintMix(selectedRgb);
                displayMixResult(bestMix);
            } catch (error) {
                console.error("Error finding mix:", error);
                mixingResult.innerHTML = '<p class="text-red-500">Error calculating mix. Please try again.</p>';
                alertUser(`An error occurred: ${error.message}`);
            } finally {
                showLoadingModal(false);
            }
        }

        function colorDiff(rgb1, rgb2) {
            // Euclidean distance in RGB space
            const dr = rgb1.r - rgb2.r;
            const dg = rgb1.g - rgb2.g;
            const db = rgb1.b - rgb2.b;
            return Math.sqrt(dr * dr + dg * dg + db * db);
        }

        function mixTwoColors(color1, ratio1, color2, ratio2) {
            const totalRatio = ratio1 + ratio2;
            if (totalRatio === 0) return { r: 0, g: 0, b: 0 }; // Avoid division by zero
            return {
                r: Math.round((color1.rgb.r * ratio1 + color2.rgb.r * ratio2) / totalRatio),
                g: Math.round((color1.rgb.g * ratio1 + color2.rgb.g * ratio2) / totalRatio),
                b: Math.round((color1.rgb.b * ratio1 + color2.rgb.b * ratio2) / totalRatio)
            };
        }

        function mixThreeColors(color1, ratio1, color2, ratio2, color3, ratio3) {
            const totalRatio = ratio1 + ratio2 + ratio3;
            if (totalRatio === 0) return { r: 0, g: 0, b: 0 };
            return {
                r: Math.round((color1.rgb.r * ratio1 + color2.rgb.r * ratio2 + color3.rgb.r * ratio3) / totalRatio),
                g: Math.round((color1.rgb.g * ratio1 + color2.rgb.g * ratio2 + color3.rgb.g * ratio3) / totalRatio),
                b: Math.round((color1.rgb.b * ratio1 + color2.rgb.b * ratio2 + color3.rgb.b * ratio3) / totalRatio)
            };
        }

        function findClosestPaintMix(targetRgb) {
            let bestMatch = {
                paintNames: [],
                mixedRgb: null,
                diff: Infinity,
                recipe: ""
            };

            // 1. Check single paints
            for (const paint of WINSOR_NEWTON_ACRYLICS) {
                const diff = colorDiff(targetRgb, paint.rgb);
                if (diff < bestMatch.diff) {
                    bestMatch = {
                        paintNames: [paint.name],
                        mixedRgb: paint.rgb,
                        diff: diff,
                        recipe: `1 part ${paint.name}`
                    };
                }
            }

            // 2. Check two-paint mixes
            // Ratios to try for two paints (e.g., 1:3, 1:2, 1:1, 2:1, 3:1)
            const ratios = [
                { r1: 1, r2: 3 }, { r1: 1, r2: 2 }, { r1: 1, r2: 1 },
                { r1: 2, r2: 1 }, { r1: 3, r2: 1 }
            ];

            for (let i = 0; i < WINSOR_NEWTON_ACRYLICS.length; i++) {
                for (let j = i + 1; j < WINSOR_NEWTON_ACRYLICS.length; j++) {
                    const paint1 = WINSOR_NEWTON_ACRYLICS[i];
                    const paint2 = WINSOR_NEWTON_ACRYLICS[j];

                    for (const ratio of ratios) {
                        let mixedRgb = mixTwoColors(paint1, ratio.r1, paint2, ratio.r2);
                        let diff = colorDiff(targetRgb, mixedRgb);
                        if (diff < bestMatch.diff) {
                            bestMatch = {
                                paintNames: [paint1.name, paint2.name],
                                mixedRgb: mixedRgb,
                                diff: diff,
                                recipe: `${ratio.r1} part(s) ${paint1.name} + ${ratio.r2} part(s) ${paint2.name}`
                            };
                        }
                        // Try swapped ratio as well if r1 != r2
                        if (ratio.r1 !== ratio.r2) {
                             mixedRgb = mixTwoColors(paint1, ratio.r2, paint2, ratio.r1); // Swapped
                             diff = colorDiff(targetRgb, mixedRgb);
                             if (diff < bestMatch.diff) {
                                bestMatch = {
                                    paintNames: [paint1.name, paint2.name],
                                    mixedRgb: mixedRgb,
                                    diff: diff,
                                    recipe: `${ratio.r2} part(s) ${paint1.name} + ${ratio.r1} part(s) ${paint2.name}`
                                };
                            }
                        }
                    }
                }
            }
            
            // 3. Check three-paint mixes (simplified: equal parts or one dominant)
            // For simplicity, we'll try equal parts for any three distinct paints.
            // A more complex approach would try varying ratios for 3 paints, but can be slow.
            if (WINSOR_NEWTON_ACRYLICS.length >= 3) {
                for (let i = 0; i < WINSOR_NEWTON_ACRYLICS.length; i++) {
                    for (let j = i + 1; j < WINSOR_NEWTON_ACRYLICS.length; j++) {
                        for (let k = j + 1; k < WINSOR_NEWTON_ACRYLICS.length; k++) {
                            const paint1 = WINSOR_NEWTON_ACRYLICS[i];
                            const paint2 = WINSOR_NEWTON_ACRYLICS[j];
                            const paint3 = WINSOR_NEWTON_ACRYLICS[k];

                            // Equal parts
                            let mixedRgb = mixThreeColors(paint1, 1, paint2, 1, paint3, 1);
                            let diff = colorDiff(targetRgb, mixedRgb);
                            if (diff < bestMatch.diff) {
                                bestMatch = {
                                    paintNames: [paint1.name, paint2.name, paint3.name],
                                    mixedRgb: mixedRgb,
                                    diff: diff,
                                    recipe: `1 part ${paint1.name} + 1 part ${paint2.name} + 1 part ${paint3.name} (approx. equal parts)`
                                };
                            }

                            // Try dominant mixes (2 parts of one, 1 part of others)
                            const dominantRatios = [
                                {r1:2, r2:1, r3:1},
                                {r1:1, r2:2, r3:1},
                                {r1:1, r2:1, r3:2}
                            ];
                            for (const dr of dominantRatios) {
                                mixedRgb = mixThreeColors(paint1, dr.r1, paint2, dr.r2, paint3, dr.r3);
                                diff = colorDiff(targetRgb, mixedRgb);
                                if (diff < bestMatch.diff) {
                                     bestMatch = {
                                        paintNames: [paint1.name, paint2.name, paint3.name],
                                        mixedRgb: mixedRgb,
                                        diff: diff,
                                        recipe: `${dr.r1} part(s) ${paint1.name} + ${dr.r2} part(s) ${paint2.name} + ${dr.r3} part(s) ${paint3.name}`
                                    };
                                }
                            }
                        }
                    }
                }
            }
            return bestMatch;
        }


        function displayMixResult(mix) {
            if (!mix || !mix.mixedRgb) {
                mixingResult.innerHTML = '<p class="text-red-500">Could not find a suitable mix.</p>';
                return;
            }

            let paintSwatchesHTML = '';
            if (mix.paintNames && mix.paintNames.length > 0) {
                mix.paintNames.forEach(name => {
                    const paintData = WINSOR_NEWTON_ACRYLICS.find(p => p.name === name);
                    if (paintData) {
                        paintSwatchesHTML += `<span class="paint-swatch" style="background-color: rgb(${paintData.rgb.r}, ${paintData.rgb.g}, ${paintData.rgb.b});" title="${name}"></span>`;
                    }
                });
            }


            mixingResult.innerHTML = `
                <div class="flex items-center mb-3">
                    <span class="color-swatch mr-3" style="background-color: rgb(${mix.mixedRgb.r}, ${mix.mixedRgb.g}, ${mix.mixedRgb.b});"></span>
                    <div>
                        <p class="font-semibold text-gray-800">Closest Mix Found (RGB: ${mix.mixedRgb.r}, ${mix.mixedRgb.g}, ${mix.mixedRgb.b})</p>
                        <p class="text-sm text-gray-600">Color Difference Score: ${mix.diff.toFixed(2)} (lower is better)</p>
                    </div>
                </div>
                <p class="text-gray-700 font-medium mb-1">Recipe:</p>
                <div class="flex items-center mb-2">
                    ${paintSwatchesHTML}
                </div>
                <p class="text-gray-700 bg-gray-100 p-2 rounded">${mix.recipe}</p>
            `;
        }

        // --- Utility Functions ---
        function componentToHex(c) {
            const hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }

        function rgbToHex(r, g, b) {
            return componentToHex(r) + componentToHex(g) + componentToHex(b);
        }

        function showLoadingModal(show) {
            loadingModal.style.display = show ? "block" : "none";
        }
        
        // Simple alert - replace with a proper modal if needed
        function alertUser(message) {
            // For now, using browser's alert. Could be replaced with a custom modal.
            // Create a temporary modal for alerts
            let existingModal = document.getElementById('alertModal');
            if (existingModal) existingModal.remove();

            const alertModal = document.createElement('div');
            alertModal.id = 'alertModal';
            alertModal.className = 'modal';
            alertModal.style.display = 'block';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            const closeButton = document.createElement('span');
            closeButton.className = 'modal-close-button';
            closeButton.innerHTML = '&times;';
            closeButton.onclick = () => { alertModal.style.display = 'none'; alertModal.remove(); };
            
            const messageP = document.createElement('p');
            messageP.textContent = message;
            messageP.className = 'text-gray-700 my-4';

            const okButton = document.createElement('button');
            okButton.textContent = 'OK';
            okButton.className = 'bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg';
            okButton.onclick = () => { alertModal.style.display = 'none'; alertModal.remove(); };

            modalContent.appendChild(closeButton);
            modalContent.appendChild(messageP);
            modalContent.appendChild(okButton);
            alertModal.appendChild(modalContent);
            document.body.appendChild(alertModal);
        }

        // Initial canvas placeholder
        function drawInitialCanvasPlaceholder() {
            imageCanvas.width = imageCanvas.parentElement.clientWidth > 0 ? Math.min(imageCanvas.parentElement.clientWidth, 500) : 300;
            imageCanvas.height = imageCanvas.width * (2/3); // Maintain a common aspect ratio like 3:2
            canvasCtx.fillStyle = '#e5e7eb'; // bg-gray-200
            canvasCtx.fillRect(0, 0, imageCanvas.width, imageCanvas.height);
            canvasCtx.fillStyle = '#9ca3af'; // text-gray-400
            canvasCtx.textAlign = 'center';
            canvasCtx.textBaseline = 'middle';
            canvasCtx.font = '14px Inter';
            wrapText(canvasCtx, 'Upload an image to begin', imageCanvas.width / 2, imageCanvas.height / 2, imageCanvas.width - 20, 18);
        }
        
        function wrapText(context, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            for(let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = context.measureText(testLine);
                const testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    context.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            }
            context.fillText(line, x, y);
        }

        // Call on load
        drawInitialCanvasPlaceholder();
        // Adjust canvas on resize
        window.addEventListener('resize', () => {
            if (!currentImage) { // Only redraw placeholder if no image is loaded
                 drawInitialCanvasPlaceholder();
            } else { // If image is loaded, redraw it (optional, or just let it be)
                const maxWidth = imageCanvas.parentElement.clientWidth > 0 ? Math.min(imageCanvas.parentElement.clientWidth, 500) : 500;
                const scale = Math.min(maxWidth / currentImage.width, 1);
                imageCanvas.width = currentImage.width * scale;
                imageCanvas.height = currentImage.height * scale;
                canvasCtx.drawImage(currentImage, 0, 0, imageCanvas.width, imageCanvas.height);
            }
        });

    </script>
</body>
</html>
